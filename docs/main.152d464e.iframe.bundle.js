(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{357:function(module,exports,__webpack_require__){__webpack_require__(358),__webpack_require__(515),__webpack_require__(516),__webpack_require__(680),module.exports=__webpack_require__(663)},425:function(module,exports){},516:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);__webpack_require__(256)},663:function(module,exports,__webpack_require__){"use strict";(function(module){(0,__webpack_require__(256).configure)([__webpack_require__(664)],module,!1)}).call(this,__webpack_require__(200)(module))},664:function(module,exports,__webpack_require__){var map={"./sb/index.sb.tsx":679};function webpackContext(req){var id=webpackContextResolve(req);return __webpack_require__(id)}function webpackContextResolve(req){if(!__webpack_require__.o(map,req)){var e=new Error("Cannot find module '"+req+"'");throw e.code="MODULE_NOT_FOUND",e}return map[req]}webpackContext.keys=function webpackContextKeys(){return Object.keys(map)},webpackContext.resolve=webpackContextResolve,module.exports=webpackContext,webpackContext.id=664},679:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,"Pannel",(function(){return index_sb_Pannel}));__webpack_require__(665),__webpack_require__(82),__webpack_require__(16),__webpack_require__(666),__webpack_require__(134),__webpack_require__(314),__webpack_require__(47),__webpack_require__(53),__webpack_require__(67),__webpack_require__(30),__webpack_require__(25),__webpack_require__(35),__webpack_require__(92),__webpack_require__(56),__webpack_require__(139);var react=__webpack_require__(6);__webpack_require__(42),__webpack_require__(48);function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var BRUSH_TYPES,Color=function Color(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,g=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,b=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;_classCallCheck(this,Color),this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0,this.r=r,this.g=g,this.b=b,this.a=a},defaultBrushState={width:20,color:new Color};!function(BRUSH_TYPES){BRUSH_TYPES.PEN="PEN"}(BRUSH_TYPES||(BRUSH_TYPES={}));__webpack_require__(31),__webpack_require__(32),__webpack_require__(68),__webpack_require__(21),__webpack_require__(205),__webpack_require__(117),__webpack_require__(206),__webpack_require__(207),__webpack_require__(204),__webpack_require__(208);function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var EL_TAGS,elID=1,PElement=function(){function PElement(){!function PElement_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,PElement),this.id="el-".concat(elID++),this.tag=EL_TAGS.PANNEL,this.offset={x:0,y:0},this.children=[]}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}(PElement,[{key:"addChild",value:function addChild(child){return this.children.push(child),child}},{key:"removeChild",value:function removeChild(id){var index=this.children.findIndex((function(_ref){var _id=_ref.id;return id===_id}));index>-1&&this.children.splice(index,1)}},{key:"getChildren",value:function getChildren(){return this.children}}]),PElement}();function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function BrushEl_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){return o.__proto__=p,o})(o,p)}function _createSuper(Derived){var hasNativeReflectConstruct=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _possibleConstructorReturn(self,call){return!call||"object"!==_typeof(call)&&"function"!=typeof call?function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self):call}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}!function(EL_TAGS){EL_TAGS[EL_TAGS.PANNEL=0]="PANNEL",EL_TAGS[EL_TAGS.LAYER=1]="LAYER",EL_TAGS[EL_TAGS.BRUSH=2]="BRUSH"}(EL_TAGS||(EL_TAGS={}));var BrushEl_BrushEl=function(_PElement){!function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass)}(BrushEl,_PElement);var _super=_createSuper(BrushEl);function BrushEl(){var _this;BrushEl_classCallCheck(this,BrushEl);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return(_this=_super.call.apply(_super,[this].concat(args))).tag=EL_TAGS.BRUSH,_this.brushType=BRUSH_TYPES.UNKNOW,_this.state={width:10,color:new Color},_this.data=[],_this.nextData=[],_this}return BrushEl}(PElement);function Input_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var Input_Input=function(){function Input(cover,state){var _this=this;!function Input_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,Input),this.state=void 0,this.dpr=window.devicePixelRatio,this.curBrush=null,this.pointId=NaN,this.onPointStart=function(e){console.log("point start"),isNaN(_this.pointId)&&(_this.pointId=e.pointerId),e.preventDefault(),_this.dpr=window.devicePixelRatio;var events=e.getCoalescedEvents?e.getCoalescedEvents():[e];_this.curBrush=new BrushEl_BrushEl,_this.curBrush.brushType=BRUSH_TYPES.PEN,_this.curBrush.state.width=_this.state.width,_this.curBrush.state.color=_this.state.color,_this.loadBrushData(events,[]),_this.onBegin(_this.curBrush)},this.loadBrushData=function(e,nextE){if(_this.curBrush){var data=_this.curBrush.data;e.forEach((function(e){data.push({position:{x:Math.round(e.offsetX*_this.dpr),y:Math.round(e.offsetY*_this.dpr)},press:"pen"===e.pointerType||e.pressure?e.pressure:1})})),_this.curBrush.nextData=nextE.map((function(e){return{position:{x:e.offsetX*_this.dpr,y:e.offsetY*_this.dpr},press:e.pressure||1}}))}},this.onPointMove=function(e){if(console.time("onPointMove"),e.preventDefault(),e.pointerId===_this.pointId&&_this.curBrush){var events=e.getCoalescedEvents?e.getCoalescedEvents():[];events.push(e),_this.loadBrushData(events,[]),_this.onUpdate(_this.curBrush),console.timeEnd("onPointMove")}},this.onPointEnd=function(e){console.time("onPointEnd"),e.pointerId===_this.pointId&&_this.curBrush&&(_this.curBrush.nextData=[],_this.onEnd(_this.curBrush),_this.curBrush=null,_this.pointId=NaN,console.timeEnd("onPointEnd"))},cover.addEventListener("pointerdown",this.onPointStart,{passive:!1}),cover.addEventListener("pointermove",this.onPointMove,{passive:!1}),cover.addEventListener("pointerup",this.onPointEnd,{passive:!1}),cover.addEventListener("pointercancel",this.onPointEnd,{passive:!1}),cover.addEventListener("pointerout",this.onPointEnd,{passive:!1}),this.state=state}return function Input_createClass(Constructor,protoProps,staticProps){return protoProps&&Input_defineProperties(Constructor.prototype,protoProps),staticProps&&Input_defineProperties(Constructor,staticProps),Constructor}(Input,[{key:"onBegin",value:function onBegin(brush){}},{key:"onUpdate",value:function onUpdate(brush){}},{key:"onEnd",value:function onEnd(brush){}}]),Input}();function LayerEl_typeof(obj){return(LayerEl_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function LayerEl_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function LayerEl_setPrototypeOf(o,p){return(LayerEl_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){return o.__proto__=p,o})(o,p)}function LayerEl_createSuper(Derived){var hasNativeReflectConstruct=function LayerEl_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var result,Super=LayerEl_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=LayerEl_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return LayerEl_possibleConstructorReturn(this,result)}}function LayerEl_possibleConstructorReturn(self,call){return!call||"object"!==LayerEl_typeof(call)&&"function"!=typeof call?function LayerEl_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self):call}function LayerEl_getPrototypeOf(o){return(LayerEl_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}var LayerEl_LayerEl=function(_PElement){!function LayerEl_inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&LayerEl_setPrototypeOf(subClass,superClass)}(LayerEl,_PElement);var _super=LayerEl_createSuper(LayerEl);function LayerEl(){var _this;LayerEl_classCallCheck(this,LayerEl);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return(_this=_super.call.apply(_super,[this].concat(args))).tag=EL_TAGS.LAYER,_this}return LayerEl}(PElement);__webpack_require__(192),__webpack_require__(678),__webpack_require__(313);function PannelEl_typeof(obj){return(PannelEl_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(obj){return typeof obj}:function _typeof(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}function PannelEl_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function PannelEl_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _get(target,property,receiver){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function _get(target,property,receiver){var base=function _superPropBase(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=PannelEl_getPrototypeOf(object)););return object}(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(receiver):desc.value}})(target,property,receiver||target)}function PannelEl_setPrototypeOf(o,p){return(PannelEl_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(o,p){return o.__proto__=p,o})(o,p)}function PannelEl_createSuper(Derived){var hasNativeReflectConstruct=function PannelEl_isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var result,Super=PannelEl_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=PannelEl_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return PannelEl_possibleConstructorReturn(this,result)}}function PannelEl_possibleConstructorReturn(self,call){return!call||"object"!==PannelEl_typeof(call)&&"function"!=typeof call?function PannelEl_assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self):call}function PannelEl_getPrototypeOf(o){return(PannelEl_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}var PannelEl_PannelEl=function(_PElement){!function PannelEl_inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&PannelEl_setPrototypeOf(subClass,superClass)}(PannelEl,_PElement);var _super=PannelEl_createSuper(PannelEl);function PannelEl(){var _this;PannelEl_classCallCheck(this,PannelEl);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return(_this=_super.call.apply(_super,[this].concat(args))).tag=EL_TAGS.PANNEL,_this.activeLayerId="",_this.width=0,_this.height=0,_this}return function PannelEl_createClass(Constructor,protoProps,staticProps){return protoProps&&PannelEl_defineProperties(Constructor.prototype,protoProps),staticProps&&PannelEl_defineProperties(Constructor,staticProps),Constructor}(PannelEl,[{key:"addChild",value:function addChild(child){return this.activeLayerId||(this.activeLayerId=child.id),_get(PannelEl_getPrototypeOf(PannelEl.prototype),"addChild",this).call(this,child)}},{key:"addBrush",value:function addBrush(brushEl){var layerId=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.activeLayerId;if(!layerId)return null;var layer=this.children.find((function(_ref){return _ref.id===layerId}));return layer?(layer.addChild(brushEl),brushEl):null}},{key:"removeBrush",value:function removeBrush(brushEl){var layerId=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.activeLayerId;if(!layerId)return null;var layer=this.children.find((function(_ref2){return _ref2.id===layerId}));if(!layer)return null;var brushList=layer.getChildren(),brushIndex=brushList.findIndex((function(_brushEl){return _brushEl===brushEl}));return brushIndex>-1&&brushList.splice(brushIndex,1),brushEl}}]),PannelEl}(PElement);function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function createEmpty(w,h){var root=new PannelEl_PannelEl;return root.width=w,root.height=h,root.addChild(new LayerEl_LayerEl),root}function parseEl(pannelElStr){var _elMap;if(!pannelElStr)return null;var elMap=(_defineProperty(_elMap={},EL_TAGS.PANNEL,PannelEl_PannelEl),_defineProperty(_elMap,EL_TAGS.LAYER,LayerEl_LayerEl),_defineProperty(_elMap,EL_TAGS.BRUSH,BrushEl_BrushEl),_elMap);return function copy(vEl,elMap){var el=new elMap[vEl.tag];for(var key in vEl)"children"!==key&&(el[key]=vEl[key]);return vEl.children.forEach((function(vEl){el.addChild(copy(vEl,elMap))})),el}(JSON.parse(pannelElStr),elMap)}var addBrushHandle={do:function _do(rootEl,operate){var data=operate.data;rootEl.addBrush(data.brushEl,data.targetLayerId)},revert:function revert(rootEl,operate){var data=operate.data;rootEl.removeBrush(data.brushEl,data.targetLayerId)}},events_events=__webpack_require__(353);function Recorder_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var Recorder_Recorder=function(){function Recorder(){!function Recorder_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,Recorder),this.operateList=[],this.curIndex=-1,this.rootEl=null,this.size=100,this.eventEmitter=new events_events.EventEmitter,this.operateHandle={addBrush:addBrushHandle}}return function Recorder_createClass(Constructor,protoProps,staticProps){return protoProps&&Recorder_defineProperties(Constructor.prototype,protoProps),staticProps&&Recorder_defineProperties(Constructor,staticProps),Constructor}(Recorder,[{key:"init",value:function init(pannelEl){this.rootEl=pannelEl}},{key:"on",value:function on(name,listener){this.eventEmitter.addListener(name,listener)}},{key:"off",value:function off(name,listener){this.eventEmitter.removeListener(name,listener)}},{key:"emit",value:function emit(name){for(var _this$eventEmitter,_len=arguments.length,params=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)params[_key-1]=arguments[_key];(_this$eventEmitter=this.eventEmitter).emit.apply(_this$eventEmitter,[name].concat(params))}},{key:"undo",value:function undo(){if(!this.rootEl)return!1;if(this.curIndex<0)return!1;var operate=this.operateList[this.curIndex--];return this.operateHandle[operate.type].revert(this.rootEl,operate),this.emit("update",this.getUpdateInfo()),!0}},{key:"getUpdateInfo",value:function getUpdateInfo(){return{hasUndo:this.curIndex>-1,hasRedo:this.curIndex<this.operateList.length-1}}},{key:"redo",value:function redo(){if(!this.rootEl)return!1;if(this.curIndex>=this.operateList.length-1)return!1;var operate=this.operateList[++this.curIndex];return this.operateHandle[operate.type].do(this.rootEl,operate),this.emit("update",this.getUpdateInfo()),!0}},{key:"addOperate",value:function addOperate(operate){this.operateList.splice(this.curIndex+1),this.operateList.push(operate);var extraCount=this.operateList.length-this.size;extraCount>0&&this.operateList.splice(0,extraCount),this.curIndex=this.operateList.length-1,this.emit("update",this.getUpdateInfo())}}]),Recorder}();__webpack_require__(315),__webpack_require__(321),__webpack_require__(322),__webpack_require__(323),__webpack_require__(324),__webpack_require__(325),__webpack_require__(326),__webpack_require__(327),__webpack_require__(328),__webpack_require__(329),__webpack_require__(330),__webpack_require__(331),__webpack_require__(332),__webpack_require__(333),__webpack_require__(334),__webpack_require__(335),__webpack_require__(336),__webpack_require__(337),__webpack_require__(338),__webpack_require__(339),__webpack_require__(340),__webpack_require__(341),__webpack_require__(342),__webpack_require__(343),__webpack_require__(344);function createShader(gl,type,source){var shader=gl.createShader(type);if(!shader)throw new Error("create shader faild");if(gl.shaderSource(shader,source),gl.compileShader(shader),gl.getShaderParameter(shader,gl.COMPILE_STATUS))return shader;throw new Error("[Compile Shader Failed] ".concat(gl.getShaderInfoLog(shader)))}function createProgram(gl,vertexShader,fragmentShader){var program=gl.createProgram();if(!program)throw new Error("create program faild");if(gl.attachShader(program,vertexShader),gl.attachShader(program,fragmentShader),gl.linkProgram(program),gl.getProgramParameter(program,gl.LINK_STATUS))return program;throw new Error("Fail link program: ".concat(gl.getProgramInfoLog(program)))}function createAttrBuffer(gl,program,bufferInfo,name){var location=gl.getAttribLocation(program,name),buffer=gl.createBuffer();if(!buffer)throw new Error("Fail create buffer");bufferInfo[name]={buffer:buffer,location:location}}function setAttrData(gl,name,bufferInfo,data){gl.bindBuffer(gl.ARRAY_BUFFER,bufferInfo[name].buffer),gl.bufferData(gl.ARRAY_BUFFER,data,gl.STATIC_DRAW)}function Pen_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var Pen_Pen=function(){function Pen(gl){!function Pen_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,Pen),this.programs=void 0,this.lineBufferInfo={},this.dotBufferInfo={},this.count=0,this.gl=void 0;var lineFragmentShader=createShader(gl,gl.FRAGMENT_SHADER,"\n    precision highp float;\n\n    uniform vec4 u_brushColor;\n\n    void main(){\n    \n        gl_FragColor = u_brushColor;\n    }\n"),lineProgram=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,"\n    precision highp float;\n\n    // gl窗口大小.\n    uniform vec2 u_windowSize;\n\n    // 笔刷宽度.\n    uniform float u_brushWidth;\n\n    // 压感 0~1.\n    attribute float a_press;\n\n    // 偏移方向 -1/1.\n    attribute float a_offetDirection;\n\n    // 开始坐标.\n    attribute vec2 a_position0;\n\n    // 结束坐标.\n    attribute vec2 a_position1;\n\n    // 当前坐标.\n    attribute vec2 a_position;\n   \n    \n    void main() { \n\n        float dist = 0.5 * u_brushWidth * a_offetDirection * a_press;\n\n        vec2 direction = normalize(a_position1- a_position0);\n\n        vec2 canvasPosition = a_position + (dist * vec2(direction.y, -direction.x));\n\n        gl_Position = vec4( (canvasPosition/u_windowSize * 2.0 - 1.0) * vec2(1, -1), 1, 1 );\n        \n    }\n"),lineFragmentShader),dotFragmentShader=createShader(gl,gl.FRAGMENT_SHADER,"\n    precision highp float;\n\n    uniform vec4 u_brushColor;\n\n    // gl窗口大小.\n    uniform vec2 u_windowSize;\n    \n    // 圆心点.\n    varying vec2 v_center;\n\n    // 半径.\n    varying float v_r;\n\n\n    void main(){\n        vec2 curPosition = vec2(gl_FragCoord.x, u_windowSize.y - gl_FragCoord.y);\n        if (distance(curPosition, v_center) <= v_r) {\n          gl_FragColor = u_brushColor;\n        } else {\n          discard;\n        }\n        // gl_FragColor = vec4(gl_FragCoord.x * 0.001, 0,0,1.0);\n    }\n"),dotProgram=createProgram(gl,createShader(gl,gl.VERTEX_SHADER,"\n    precision highp float;\n\n    // gl窗口大小.\n    uniform vec2 u_windowSize;\n\n    // 笔刷宽度.\n    uniform float u_brushWidth;\n\n    // 压感 0~1.\n    attribute float a_press;\n\n    // 当前坐标.\n    attribute vec2 a_position;\n\n    // 偏移方向坐标.\n    attribute vec2 a_offset;\n\n    // 半径.\n    varying float v_r;\n\n    // 圆心点.\n    varying vec2 v_center;\n    \n    void main() { \n\n        v_r = 0.5 * u_brushWidth * a_press;\n\n        v_center = a_position;\n\n        vec2 canvasPosition = a_position + (a_offset * v_r);\n\n        gl_Position = vec4( (canvasPosition/u_windowSize * 2.0 - 1.0) * vec2(1, -1), 1, 1 );\n        \n    }\n"),dotFragmentShader);this.programs={lineProgram:lineProgram,dotProgram:dotProgram},this.gl=gl,this.initLineProgram(),this.initRoundProgram()}return function Pen_createClass(Constructor,protoProps,staticProps){return protoProps&&Pen_defineProperties(Constructor.prototype,protoProps),staticProps&&Pen_defineProperties(Constructor,staticProps),Constructor}(Pen,[{key:"initLineProgram",value:function initLineProgram(){createAttrBuffer(this.gl,this.programs.lineProgram,this.lineBufferInfo,"a_press"),createAttrBuffer(this.gl,this.programs.lineProgram,this.lineBufferInfo,"a_offetDirection"),createAttrBuffer(this.gl,this.programs.lineProgram,this.lineBufferInfo,"a_position0"),createAttrBuffer(this.gl,this.programs.lineProgram,this.lineBufferInfo,"a_position1"),createAttrBuffer(this.gl,this.programs.lineProgram,this.lineBufferInfo,"a_position")}},{key:"initRoundProgram",value:function initRoundProgram(){createAttrBuffer(this.gl,this.programs.dotProgram,this.dotBufferInfo,"a_press"),createAttrBuffer(this.gl,this.programs.dotProgram,this.dotBufferInfo,"a_position"),createAttrBuffer(this.gl,this.programs.dotProgram,this.dotBufferInfo,"a_offset")}},{key:"setBrushWidth",value:function setBrushWidth(program,val){var location=this.gl.getUniformLocation(program,"u_brushWidth");this.gl.uniform1f(location,val)}},{key:"setWindowSize",value:function setWindowSize(program){for(var _this$gl,location=this.gl.getUniformLocation(program,"u_windowSize"),_len=arguments.length,valus=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)valus[_key-1]=arguments[_key];(_this$gl=this.gl).uniform2f.apply(_this$gl,[location].concat(valus))}},{key:"setBrushColor",value:function setBrushColor(program,r,g,b,a){var location=this.gl.getUniformLocation(program,"u_brushColor");this.gl.uniform4f(location,r/255,g/255,b/255,a)}},{key:"drawLines",value:function drawLines(state,data){var width=state.width,color=state.color;if(this.gl.useProgram(this.programs.lineProgram),this.setWindowSize(this.programs.lineProgram,this.gl.canvas.width,this.gl.canvas.height),this.setBrushWidth(this.programs.lineProgram,width),this.setBrushColor(this.programs.lineProgram,color.r,color.g,color.b,color.a),!(data.length<2)){for(var pointCount=2*(data.length-1)*3,position=new Float32Array(2*pointCount),position0=new Float32Array(2*pointCount),position1=new Float32Array(2*pointCount),offetDirection=new Float32Array(pointCount),press=new Float32Array(pointCount),i=1;i<data.length;i++){var _data=data[i-1],_data$position=_data.position,x0=_data$position.x,y0=_data$position.y,press0=_data.press,_data$i=data[i],_data$i$position=_data$i.position,x1=_data$i$position.x,y1=_data$i$position.y,press1=_data$i.press,index=i-1;position0[12*index]=x0,position0[12*index+1]=y0,position0[12*index+2]=x0,position0[12*index+3]=y0,position0[12*index+4]=x0,position0[12*index+5]=y0,position0[12*index+6]=x0,position0[12*index+7]=y0,position0[12*index+8]=x0,position0[12*index+9]=y0,position0[12*index+10]=x0,position0[12*index+11]=y0,position1[12*index]=x1,position1[12*index+1]=y1,position1[12*index+2]=x1,position1[12*index+3]=y1,position1[12*index+4]=x1,position1[12*index+5]=y1,position1[12*index+6]=x1,position1[12*index+7]=y1,position1[12*index+8]=x1,position1[12*index+9]=y1,position1[12*index+10]=x1,position1[12*index+11]=y1,position[12*index]=x0,position[12*index+1]=y0,position[12*index+2]=x0,position[12*index+3]=y0,position[12*index+4]=x1,position[12*index+5]=y1,position[12*index+6]=x1,position[12*index+7]=y1,position[12*index+8]=x1,position[12*index+9]=y1,position[12*index+10]=x0,position[12*index+11]=y0,offetDirection[6*index]=1,offetDirection[6*index+1]=-1,offetDirection[6*index+2]=-1,offetDirection[6*index+3]=1,offetDirection[6*index+4]=-1,offetDirection[6*index+5]=1,press[6*index]=press0,press[6*index+1]=press0,press[6*index+2]=press1,press[6*index+3]=press1,press[6*index+4]=press1,press[6*index+5]=press0}setAttrData(this.gl,"a_position",this.lineBufferInfo,position),this.gl.enableVertexAttribArray(this.lineBufferInfo.a_position.location),this.gl.vertexAttribPointer(this.lineBufferInfo.a_position.location,2,this.gl.FLOAT,!1,0,0),setAttrData(this.gl,"a_position0",this.lineBufferInfo,position0),this.gl.enableVertexAttribArray(this.lineBufferInfo.a_position0.location),this.gl.vertexAttribPointer(this.lineBufferInfo.a_position0.location,2,this.gl.FLOAT,!1,0,0),setAttrData(this.gl,"a_position1",this.lineBufferInfo,position1),this.gl.enableVertexAttribArray(this.lineBufferInfo.a_position1.location),this.gl.vertexAttribPointer(this.lineBufferInfo.a_position1.location,2,this.gl.FLOAT,!1,0,0),setAttrData(this.gl,"a_offetDirection",this.lineBufferInfo,offetDirection),this.gl.enableVertexAttribArray(this.lineBufferInfo.a_offetDirection.location),this.gl.vertexAttribPointer(this.lineBufferInfo.a_offetDirection.location,1,this.gl.FLOAT,!1,0,0),setAttrData(this.gl,"a_press",this.lineBufferInfo,press),this.gl.enableVertexAttribArray(this.lineBufferInfo.a_press.location),this.gl.vertexAttribPointer(this.lineBufferInfo.a_press.location,1,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLES,0,2*(data.length-1)*3)}}},{key:"drawDot",value:function drawDot(state,data){if(data.length){var width=state.width,color=state.color;this.gl.useProgram(this.programs.dotProgram),this.setWindowSize(this.programs.dotProgram,this.gl.canvas.width,this.gl.canvas.height),this.setBrushWidth(this.programs.dotProgram,width),this.setBrushColor(this.programs.dotProgram,color.r,color.g,color.b,color.a);var pointCount=2*data.length*3,press=new Float32Array(pointCount),position=new Float32Array(2*pointCount),offset=new Float32Array(2*pointCount);data.forEach((function(_ref,index){var _ref$position=_ref.position,x=_ref$position.x,y=_ref$position.y,p=_ref.press;press[6*index]=p,press[6*index+1]=p,press[6*index+2]=p,press[6*index+3]=p,press[6*index+4]=p,press[6*index+5]=p,position[12*index]=x,position[12*index+1]=y,position[12*index+2]=x,position[12*index+3]=y,position[12*index+4]=x,position[12*index+5]=y,position[12*index+6]=x,position[12*index+7]=y,position[12*index+8]=x,position[12*index+9]=y,position[12*index+10]=x,position[12*index+11]=y,offset[12*index]=-1,offset[12*index+1]=1,offset[12*index+2]=-1,offset[12*index+3]=-1,offset[12*index+4]=1,offset[12*index+5]=-1,offset[12*index+6]=1,offset[12*index+7]=-1,offset[12*index+8]=1,offset[12*index+9]=1,offset[12*index+10]=-1,offset[12*index+11]=1})),setAttrData(this.gl,"a_press",this.dotBufferInfo,press),this.gl.enableVertexAttribArray(this.dotBufferInfo.a_press.location),this.gl.vertexAttribPointer(this.dotBufferInfo.a_press.location,1,this.gl.FLOAT,!1,0,0),setAttrData(this.gl,"a_position",this.dotBufferInfo,position),this.gl.enableVertexAttribArray(this.dotBufferInfo.a_position.location),this.gl.vertexAttribPointer(this.dotBufferInfo.a_position.location,2,this.gl.FLOAT,!1,0,0),setAttrData(this.gl,"a_offset",this.dotBufferInfo,offset),this.gl.enableVertexAttribArray(this.dotBufferInfo.a_offset.location),this.gl.vertexAttribPointer(this.dotBufferInfo.a_offset.location,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLES,0,2*data.length*3)}}},{key:"draw",value:function draw(state,data){this.drawLines(state,data),this.drawDot(state,data)}}]),Pen}();function _toConsumableArray(arr){return function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}(arr)||function _unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function Renderer_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var Renderer_Renderer=function(){function Renderer(realtimeCanvas){!function Renderer_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,Renderer),this.canvas=void 0,this.gl=void 0,this.pen=void 0,this.targetTexture=null,this.frameBuffer=null,this.renderToCanvasProgram=void 0,this.bufferInfo={},this.canvas=realtimeCanvas;var gl=realtimeCanvas.getContext("webgl",{preserveDrawingBuffer:!0,alpha:!0,depth:!1,stencil:!1});if(!gl)throw new Error("get webgl context faild");this.gl=gl,this.gl.enable(this.gl.BLEND),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA);var vertextShader=createShader(this.gl,this.gl.VERTEX_SHADER,"\n    precision highp float;\n\n    // gl窗口大小.\n    uniform vec2 u_windowSize;\n\n    // 当前坐标.\n    attribute vec2 a_position;\n\n    void main() { \n\n        // float dist = 0.5 * u_brushWidth * a_offetDirection * a_press;\n\n        // vec2 direction = normalize(a_position1- a_position0);\n\n        // vec2 canvasPosition = a_position + (dist * vec2(direction.y, -direction.x));\n\n        gl_Position = vec4( (a_position/u_windowSize * 2.0 - 1.0) * vec2(1, -1), 1, 1 );\n        \n    }\n"),fragmentShader=createShader(this.gl,this.gl.FRAGMENT_SHADER,"\n    precision highp float;\n\n    // gl窗口大小.\n    uniform vec2 u_windowSize;\n\n    uniform vec4 u_brushColor;\n\n    uniform sampler2D u_image;\n\n\n    void main(){\n\n        vec4 textColor = texture2D(u_image, vec2(gl_FragCoord.x, gl_FragCoord.y)/u_windowSize);\n        if (textColor.a > 0.0) {\n            gl_FragColor = u_brushColor;\n            // gl_FragColor = textColor;\n        } else {\n            discard;\n            // gl_FragColor = vec4(1,0,0,1);\n        }\n        // gl_FragColor = textColor;\n       \n    }\n");this.renderToCanvasProgram=createProgram(this.gl,vertextShader,fragmentShader),createAttrBuffer(this.gl,this.renderToCanvasProgram,this.bufferInfo,"a_position"),this.targetTexture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,this.targetTexture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.canvas.width,gl.canvas.height,0,gl.RGBA,gl.UNSIGNED_BYTE,null),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),this.frameBuffer=gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.targetTexture,0),this.pen=new Pen_Pen(gl)}return function Renderer_createClass(Constructor,protoProps,staticProps){return protoProps&&Renderer_defineProperties(Constructor.prototype,protoProps),staticProps&&Renderer_defineProperties(Constructor,staticProps),Constructor}(Renderer,[{key:"bind2FrameBuffer",value:function bind2FrameBuffer(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.frameBuffer),this.gl.bindTexture(this.gl.TEXTURE_2D,this.targetTexture),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}},{key:"bind2Canvas",value:function bind2Canvas(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,this.targetTexture)}},{key:"setWindowSize",value:function setWindowSize(program,w,h){var location=this.gl.getUniformLocation(program,"u_windowSize");this.gl.uniform2f(location,w,h)}},{key:"setBrushColor",value:function setBrushColor(program,r,g,b,a){var location=this.gl.getUniformLocation(program,"u_brushColor");this.gl.uniform4f(location,r/255,g/255,b/255,a)}},{key:"renderTexture",value:function renderTexture(state){var color=state.color;this.gl.useProgram(this.renderToCanvasProgram),this.setWindowSize(this.renderToCanvasProgram,this.gl.canvas.width,this.gl.canvas.height),this.setBrushColor(this.renderToCanvasProgram,color.r,color.g,color.b,color.a);var w=this.gl.canvas.width,h=this.gl.canvas.height,position=new Float32Array([0,0,w,0,w,h,0,0,0,h,w,h]);setAttrData(this.gl,"a_position",this.bufferInfo,position),this.gl.enableVertexAttribArray(this.bufferInfo.a_position.location),this.gl.vertexAttribPointer(this.bufferInfo.a_position.location,2,this.gl.FLOAT,!1,0,0),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}},{key:"renderBrush",value:function renderBrush(brushEl){brushEl.brushType;var state=brushEl.state,data=brushEl.data,nextData=brushEl.nextData;this.bind2FrameBuffer(),this.pen.draw(state,[].concat(_toConsumableArray(data),_toConsumableArray(nextData))),this.bind2Canvas(),this.renderTexture(state)}},{key:"clear",value:function clear(){this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}}]),Renderer}();function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function RenderEngine_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var defaultOpt={width:800,height:800},RenderEngine_RenderEngin=function(){function RenderEngin(view,opt){!function RenderEngine_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,RenderEngin),this.root=null,this.scroller=document.createElement("div"),this.topCanvas=document.createElement("canvas"),this.activeCanvas=document.createElement("canvas"),this.bottomCanvas=document.createElement("canvas"),this.cover=document.createElement("div"),this.renderer=void 0;var width=(opt=Object.assign({},defaultOpt,opt)).width/window.devicePixelRatio,height=opt.height/window.devicePixelRatio;this.scroller.style.width="".concat(width,"px"),this.scroller.style.height="".concat(height,"px"),this.initCanvas(this.bottomCanvas,opt,"bottomCanvas"),this.initCanvas(this.activeCanvas,opt,"active");var realTimeCanvas=document.createElement("canvas");this.initCanvas(realTimeCanvas,opt,"realTime"),this.initCanvas(this.topCanvas,opt,"top"),this.cover.style.width="".concat(width,"px"),this.cover.style.height="".concat(height,"px"),this.cover.style.background="#808080",this.cover.style.opacity="0.1",this.cover.style.touchAction="none",this.cover.style.userSelect="none",this.scroller.appendChild(this.cover),this.setLayoutStyle(this.cover,width,height),view.appendChild(this.scroller),this.renderer=new Renderer_Renderer(realTimeCanvas)}var _renderBrushes,_renderTree,_load;return function RenderEngine_createClass(Constructor,protoProps,staticProps){return protoProps&&RenderEngine_defineProperties(Constructor.prototype,protoProps),staticProps&&RenderEngine_defineProperties(Constructor,staticProps),Constructor}(RenderEngin,[{key:"initCanvas",value:function initCanvas(canvas,opt,name){var width=opt.width/window.devicePixelRatio,height=opt.height/window.devicePixelRatio;canvas.width=opt.width,canvas.height=opt.height,canvas.setAttribute(name,"qq"),this.setLayoutStyle(canvas,width,height),this.scroller.appendChild(canvas)}},{key:"setLayoutStyle",value:function setLayoutStyle(el,w,h){el.style.position="absolute",el.style.top="0",el.style.left="0",el.style.width="".concat(w,"px"),el.style.height="".concat(h,"px")}},{key:"load",value:(_load=_asyncToGenerator(regeneratorRuntime.mark((function _callee(root){return regeneratorRuntime.wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:this.root=root,this.renderTree();case 2:case"end":return _context.stop()}}),_callee,this)}))),function load(_x){return _load.apply(this,arguments)})},{key:"clear",value:function clear(){[this.topCanvas,this.activeCanvas,this.bottomCanvas].forEach((function(canvas){var ctx=canvas.getContext("2d");null==ctx||ctx.clearRect(0,0,canvas.width,canvas.height)})),this.renderer.clear()}},{key:"renderTree",value:(_renderTree=_asyncToGenerator(regeneratorRuntime.mark((function _callee2(){var activeLayerId,layers,targetCanvas,_this=this;return regeneratorRuntime.wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(this.root){_context2.next=2;break}return _context2.abrupt("return");case 2:console.time("r"),this.clear(),activeLayerId=this.root.activeLayerId,layers=this.root.getChildren(),targetCanvas=this.topCanvas,layers.forEach((function(layerEl){if(layerEl.id===activeLayerId)return _this.renderBrushes(_this.activeCanvas,layerEl.getChildren()),void(targetCanvas=_this.bottomCanvas);_this.renderBrushes(targetCanvas,layerEl.getChildren())})),console.timeEnd("r");case 9:case"end":return _context2.stop()}}),_callee2,this)}))),function renderTree(){return _renderTree.apply(this,arguments)})},{key:"renderBrushes",value:(_renderBrushes=_asyncToGenerator(regeneratorRuntime.mark((function _callee3(tagetCanvas,brushELList){var ctx,_this2=this;return regeneratorRuntime.wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if(ctx=tagetCanvas.getContext("2d")){_context3.next=3;break}return _context3.abrupt("return");case 3:this.renderer.clear(),brushELList.forEach((function(brushEl){_this2.renderer.renderBrush(brushEl)})),ctx.drawImage(this.renderer.canvas,0,0),this.renderer.clear();case 7:case"end":return _context3.stop()}}),_callee3,this)}))),function renderBrushes(_x2,_x3){return _renderBrushes.apply(this,arguments)})},{key:"submitRealTime",value:function submitRealTime(){var activeCtx=this.activeCanvas.getContext("2d");activeCtx&&(null==activeCtx||activeCtx.drawImage(this.renderer.canvas,0,0),this.renderer.clear())}},{key:"renderRealTime",value:function renderRealTime(el){this.renderer.clear(),this.renderer.renderBrush(el)}}]),RenderEngin}();function Pannel_asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function Pannel_asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){Pannel_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){Pannel_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function Pannel_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var Pannel_Pannel=function(){function Pannel(container,_opt){var _this=this;!function Pannel_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,Pannel),this.brushState=defaultBrushState,this.brushType=BRUSH_TYPES.PEN,this.pannelEl=null,this.renderEngin=void 0,this.input=void 0,this.recorder=void 0,this.size=void 0,this.onInputBegin=function(brushEl){_this.pannelEl&&(_this.pannelEl.addBrush(brushEl),_this.renderEngin.renderRealTime(brushEl))},this.onInputUpdate=function(brushEl){_this.renderEngin.renderRealTime(brushEl)},this.onInputEnd=function(brushEl){_this.pannelEl&&(_this.renderEngin.submitRealTime(),_this.recorder.addOperate({type:"addBrush",data:{targetLayerId:_this.pannelEl.activeLayerId,brushEl:brushEl}}))},this.size=Object.assign({width:800,height:800},_opt),container.addEventListener("touchstart",(function(e){return e.preventDefault()})),this.renderEngin=new RenderEngine_RenderEngin(container,this.size),this.input=new Input_Input(this.renderEngin.cover,this.brushState),this.input.onBegin=this.onInputBegin,this.input.onUpdate=this.onInputUpdate,this.input.onEnd=this.onInputEnd,this.recorder=new Recorder_Recorder}var _load,_parse,_toJson;return function Pannel_createClass(Constructor,protoProps,staticProps){return protoProps&&Pannel_defineProperties(Constructor.prototype,protoProps),staticProps&&Pannel_defineProperties(Constructor,staticProps),Constructor}(Pannel,[{key:"redo",value:function redo(){this.recorder.redo()&&this.renderEngin.renderTree()}},{key:"undo",value:function undo(){this.recorder.undo()&&this.renderEngin.renderTree()}},{key:"toJson",value:(_toJson=Pannel_asyncToGenerator(regeneratorRuntime.mark((function _callee(){return regeneratorRuntime.wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.abrupt("return",(pannelEl=this.pannelEl)?JSON.stringify(pannelEl):"");case 1:case"end":return _context.stop()}var pannelEl}),_callee,this)}))),function toJson(){return _toJson.apply(this,arguments)})},{key:"parse",value:(_parse=Pannel_asyncToGenerator(regeneratorRuntime.mark((function _callee2(json){var el;return regeneratorRuntime.wrap((function _callee2$(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return el=parseEl(json),_context2.abrupt("return",el||createEmpty(this.size.width,this.size.height));case 2:case"end":return _context2.stop()}}),_callee2,this)}))),function parse(_x){return _parse.apply(this,arguments)})},{key:"load",value:(_load=Pannel_asyncToGenerator(regeneratorRuntime.mark((function _callee3(pannelEl){return regeneratorRuntime.wrap((function _callee3$(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if("string"!=typeof pannelEl){_context3.next=4;break}return _context3.next=3,this.parse(pannelEl);case 3:pannelEl=_context3.sent;case 4:this.pannelEl=pannelEl||createEmpty(this.size.width,this.size.height),this.renderEngin.load(this.pannelEl),this.recorder.init(this.pannelEl);case 7:case"end":return _context3.stop()}}),_callee3,this)}))),function load(_x2){return _load.apply(this,arguments)})}]),Pannel}();var vconsole_min=__webpack_require__(352),vconsole_min_default=__webpack_require__.n(vconsole_min),jsx_runtime=__webpack_require__(45);function _slicedToArray(arr,i){return function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}(arr)||function _iterableToArrayLimit(arr,i){var _i=arr&&("undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"]);if(null==_i)return;var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}(arr,i)||function index_sb_unsupportedIterableToArray(o,minLen){if(!o)return;if("string"==typeof o)return index_sb_arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return index_sb_arrayLikeToArray(o,minLen)}(arr,i)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function index_sb_arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function index_sb_asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function index_sb_asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){index_sb_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){index_sb_asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}new vconsole_min_default.a,__webpack_exports__.default={title:"Example/Pannel",component:index_sb_Pannel};function index_sb_Pannel(){var pannelRef=Object(react.useRef)(null),conainerRef=Object(react.useRef)(null);Object(react.useEffect)((function(){document.body.style.overflow="hidden",setInterval(index_sb_asyncToGenerator(regeneratorRuntime.mark((function _callee(){var pannel;return regeneratorRuntime.wrap((function _callee$(_context){for(;;)switch(_context.prev=_context.next){case 0:if(!(pannel=pannelRef.current)){_context.next=8;break}return _context.t0=localStorage,_context.next=5,pannel.toJson();case 5:_context.t1=_context.sent,_context.t0.setItem.call(_context.t0,"xxx",_context.t1),console.log("save..");case 8:case"end":return _context.stop()}}),_callee)}))),5e3)}),[]),Object(react.useEffect)((function(){if(conainerRef.current){var pannel=pannelRef.current=function createPannel(container,opt){return new Pannel_Pannel(container,opt)}(conainerRef.current,{width:window.innerWidth*window.devicePixelRatio,height:window.innerHeight*window.devicePixelRatio});pannel.load(localStorage.getItem("xxx")),pannel.brushState.width=20*window.devicePixelRatio,pannel.brushState.color=new Color(0,0,0,.2)}}),[]);var _useState2=_slicedToArray(Object(react.useState)("#000000"),2),color=_useState2[0],setColor=_useState2[1],_useState4=_slicedToArray(Object(react.useState)(.2),2),opacity=_useState4[0],setOpacity=_useState4[1],_useState6=_slicedToArray(Object(react.useState)(20),2),brushWidth=_useState6[0],setBrushWidth=_useState6[1];return Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsxs)("div",{children:[Object(jsx_runtime.jsx)("button",{onClick:function clear(){localStorage.removeItem("xxx"),window.location.reload()},children:"clear"}),Object(jsx_runtime.jsx)("button",{onClick:function undo(){var pannel=pannelRef.current;null==pannel||pannel.undo()},children:"undo"}),Object(jsx_runtime.jsx)("button",{onClick:function redo(){var pannel=pannelRef.current;null==pannel||pannel.redo()},children:"redo"}),Object(jsx_runtime.jsx)("input",{type:"color",onChange:function onColorChange(e){var pannel=pannelRef.current;if(pannel){var colorStr=e.target.value;setColor(colorStr);var color=new Color(parseInt(colorStr.substr(1,2),16),parseInt(colorStr.substr(3,2),16),parseInt(colorStr.substr(5,2),16),pannel.brushState.color.a);pannel.brushState.color=color}},value:color}),"opacity ",Object(jsx_runtime.jsx)("input",{type:"range",min:0,max:1,onChange:function handleOptChange(e){var pannel=pannelRef.current;if(pannel){var value=Number(e.target.value);setOpacity(value);var oldColor=pannel.brushState.color;pannel.brushState.color=new Color(oldColor.r,oldColor.g,oldColor.b,value)}},step:.1,value:opacity}),"brush width ",Object(jsx_runtime.jsx)("input",{type:"range",min:20,max:800,onChange:function handleBrushWidth(e){var pannel=pannelRef.current;if(pannel){var width=parseInt(e.target.value);setBrushWidth(width),pannel.brushState.width=width}},step:.1,value:brushWidth})]}),Object(jsx_runtime.jsx)("div",{style:{position:"relative"},ref:conainerRef})]})}index_sb_Pannel.displayName="Pannel"},680:function(module,__webpack_exports__,__webpack_require__){"use strict";__webpack_require__.r(__webpack_exports__);var preview_namespaceObject={};__webpack_require__.r(preview_namespaceObject),__webpack_require__.d(preview_namespaceObject,"parameters",(function(){return parameters}));__webpack_require__(43),__webpack_require__(47),__webpack_require__(81),__webpack_require__(313),__webpack_require__(31),__webpack_require__(32),__webpack_require__(661),__webpack_require__(662),__webpack_require__(48);var client_api=__webpack_require__(682),esm=__webpack_require__(3),parameters={actions:{argTypesRegex:"^on[A-Z].*"},controls:{matchers:{color:/(background|color)$/i,date:/Date$/}}};function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.keys(preview_namespaceObject).forEach((function(key){var value=preview_namespaceObject[key];switch(key){case"args":case"argTypes":return esm.a.warn("Invalid args/argTypes in config, ignoring.",JSON.stringify(value));case"decorators":return value.forEach((function(decorator){return Object(client_api.b)(decorator,!1)}));case"loaders":return value.forEach((function(loader){return Object(client_api.c)(loader,!1)}));case"parameters":return Object(client_api.d)(function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}({},value),!1);case"argTypesEnhancers":return value.forEach((function(enhancer){return Object(client_api.a)(enhancer)}));case"globals":case"globalTypes":var v={};return v[key]=value,Object(client_api.d)(v,!1);default:return console.log(key+" was not supported :( !")}}))}},[[357,1,2]]]);